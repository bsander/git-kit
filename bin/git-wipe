#!/usr/bin/env bash

# Load shared functions and parse arguments
BASE_DIR=$(d() { (cd -P "$(dirname "$1")" && pwd) }; while [ -h "${S=${BASH_SOURCE[0]}}" ]; do D=$(d "$S"); S=$(readlink "$S"); [[ $S != /* ]] && S="$D/$S"; done; d "$S")
# shellcheck source=functions.sh disable=1091
source "$BASE_DIR/functions.sh"


STATUS=$(git status -s)
BRANCH=$(git current-branch || git name-rev --name-only "$(git rev-parse HEAD)")
DATE=$(date)
MESSAGE="WIPE SAVEPOINT ${BRANCH} ${DATE}\n\n${STATUS}"

(set -x; git add -A )
echo -e "$MESSAGE" | bash -cx 'git commit -F- && git reset "HEAD~1" --hard'
